<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="camera=*, geolocation=*">
    <title>Absensi App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4ec9b0;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #6a9955;
            font-size: 14px;
        }

        .camera-container {
            position: relative;
            max-width: 640px;
            width: 100%;
            background: #252526;
            border: 2px solid #3e3e42;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }

        #canvas {
            display: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            background: #0e639c;
            color: #fff;
            border: none;
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            touch-action: manipulation;
        }

        button:hover {
            background: #1177bb;
        }

        button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }

        #captureBtn {
            background: #4ec9b0;
            color: #1e1e1e;
            font-weight: bold;
        }

        #captureBtn:hover {
            background: #5dd9c0;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            background: #252526;
            border-left: 4px solid #4ec9b0;
            border-radius: 4px;
            max-width: 640px;
            width: 100%;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .status-label {
            color: #569cd6;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .status-value {
            color: #ce9178;
            padding-left: 10px;
            line-height: 1.5;
        }

        .preview {
            margin-top: 20px;
            max-width: 640px;
            width: 100%;
        }

        .preview img {
            width: 100%;
            border: 2px solid #3e3e42;
            border-radius: 8px;
        }

        .loading {
            color: #dcdcaa;
            font-style: italic;
        }

        .error {
            color: #f48771;
        }

        .success {
            color: #4ec9b0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>// JOGIIA RECORD</h1>
        <p>/* Capture attendance with location & timestamp */</p>
    </div>

    <div class="camera-container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="controls">
        <button id="startBtn">â–¶ Start Camera</button>
        <button id="captureBtn" disabled>ðŸ“· Capture</button>
        <button id="switchBtn" disabled>ðŸ”„ Switch Camera</button>
    </div>

    <div class="status">
        <div class="status-item">
            <span class="status-label">Status:</span>
            <span class="status-value" id="statusText">Waiting...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Location:</span>
            <span class="status-value" id="locationText">-</span>
        </div>
        <div class="status-item">
            <span class="status-label">Time:</span>
            <span class="status-value" id="timeText">-</span>
        </div>
    </div>

    <div class="preview" id="preview"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const switchBtn = document.getElementById('switchBtn');
        const statusText = document.getElementById('statusText');
        const locationText = document.getElementById('locationText');
        const timeText = document.getElementById('timeText');
        const preview = document.getElementById('preview');

        let stream = null;
        let currentLocation = null;
        let currentAddress = null;
        let facingMode = 'user';

        // Update time continuously
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            timeText.textContent = timeString;
        }

        setInterval(updateTime, 1000);
        updateTime();

        // Get address from coordinates using Nominatim (OpenStreetMap)
        async function getAddressFromCoords(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data && data.address) {
                    const addr = data.address;
                    let addressParts = [];
                    
                    if (addr.road) addressParts.push(addr.road);
                    if (addr.suburb) addressParts.push(addr.suburb);
                    if (addr.village) addressParts.push(addr.village);
                    if (addr.city || addr.town || addr.municipality) {
                        addressParts.push(addr.city || addr.town || addr.municipality);
                    }
                    if (addr.state) addressParts.push(addr.state);
                    if (addr.postcode) addressParts.push(addr.postcode);
                    
                    return addressParts.join(', ') || data.display_name;
                }
                return 'Address not found';
            } catch (error) {
                console.error('Error getting address:', error);
                return 'Unable to get address';
            }
        }

        // Get location
        async function getLocation() {
            if ('geolocation' in navigator) {
                statusText.innerHTML = '<span class="loading">Getting location...</span>';
                locationText.innerHTML = '<span class="loading">Fetching GPS...</span>';
                
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            altitude: position.coords.altitude,
                            heading: position.coords.heading,
                            speed: position.coords.speed
                        };
                        
                        locationText.innerHTML = '<span class="loading">Getting address...</span>';
                        currentAddress = await getAddressFromCoords(currentLocation.lat, currentLocation.lng);
                        
                        let locationInfo = `<strong>Address:</strong> ${currentAddress}<br>`;
                        locationInfo += `<strong>Coordinates:</strong> ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}<br>`;
                        locationInfo += `<strong>Accuracy:</strong> Â±${Math.round(currentLocation.accuracy)} meters`;
                        if (currentLocation.altitude) {
                            locationInfo += `<br><strong>Altitude:</strong> ${Math.round(currentLocation.altitude)} m`;
                        }
                        
                        locationText.innerHTML = locationInfo;
                        statusText.innerHTML = '<span class="success">Camera & Location ready âœ“</span>';
                    },
                    (error) => {
                        let errorMsg = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'Location permission denied';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'Location information unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'Location request timed out';
                                break;
                            default:
                                errorMsg = 'Unknown location error';
                        }
                        statusText.innerHTML = `<span class="error">${errorMsg}</span>`;
                        locationText.innerHTML = `<span class="error">${errorMsg}</span>`;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            } else {
                statusText.innerHTML = '<span class="error">Geolocation not supported</span>';
                locationText.innerHTML = '<span class="error">Geolocation not supported</span>';
            }
        }

        // Start camera
        async function startCamera() {
            try {
                statusText.innerHTML = '<span class="loading">Starting camera...</span>';
                
                // Stop previous stream if exists
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                captureBtn.disabled = false;
                switchBtn.disabled = false;
                startBtn.disabled = true;
                statusText.innerHTML = '<span class="success">Camera active âœ“</span>';
                getLocation();
            } catch (error) {
                let errorMsg = '';
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg = 'Camera permission denied. Please allow camera access in browser settings.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMsg = 'No camera found on this device.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMsg = 'Camera is already in use by another application.';
                } else {
                    errorMsg = `Camera error: ${error.message}`;
                }
                statusText.innerHTML = `<span class="error">${errorMsg}</span>`;
                console.error('Camera error:', error);
            }
        }

        startBtn.addEventListener('click', startCamera);

        // Switch camera
        switchBtn.addEventListener('click', async () => {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            await startCamera();
        });

        // Capture photo
        captureBtn.addEventListener('click', async () => {
            if (!currentLocation) {
                alert('Menunggu lokasi... Silakan coba lagi.');
                return;
            }

            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            
            // Draw video frame (flip if front camera)
            if (facingMode === 'user') {
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
            }
            ctx.drawImage(video, 0, 0);
            if (facingMode === 'user') {
                ctx.setTransform(1, 0, 0, 1, 0, 0);
            }

            // Create overlay with programmer theme
            const overlayHeight = 180;
            const padding = 15;
            const lineHeight = 18;

            // Semi-transparent background
            ctx.fillStyle = 'rgba(30, 30, 30, 0.90)';
            ctx.fillRect(0, canvas.height - overlayHeight, canvas.width, overlayHeight);

            // Border top
            ctx.fillStyle = '#4ec9b0';
            ctx.fillRect(0, canvas.height - overlayHeight, canvas.width, 3);

            // Text styling
            ctx.font = 'bold 15px "Courier New"';
            ctx.fillStyle = '#4ec9b0';
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('id-ID');
            
            let yPos = canvas.height - overlayHeight + padding + lineHeight;

            // Draw text with code-like format
            ctx.fillText('// JOGIIA RECORD', padding, yPos);
            
            ctx.font = '13px "Courier New"';
            ctx.fillStyle = '#d4d4d4';
            yPos += lineHeight + 5;
            
            // Timestamp
            ctx.fillStyle = '#569cd6';
            ctx.fillText('timestamp:', padding, yPos);
            ctx.fillStyle = '#ce9178';
            ctx.fillText(`"${timeStr}"`, padding + 95, yPos);
            
            yPos += lineHeight;
            ctx.fillStyle = '#569cd6';
            ctx.fillText('date:', padding, yPos);
            ctx.fillStyle = '#ce9178';
            const maxWidth = canvas.width - padding - 95;
            ctx.fillText(`"${dateStr}"`, padding + 95, yPos);
            
            // Address (wrap if too long)
            yPos += lineHeight;
            ctx.fillStyle = '#569cd6';
            ctx.fillText('address:', padding, yPos);
            ctx.fillStyle = '#ce9178';
            
            const addressText = `"${currentAddress}"`;
            const words = addressText.split(' ');
            let line = '';
            let xPos = padding + 95;
            
            for (let word of words) {
                const testLine = line + word + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && line !== '') {
                    ctx.fillText(line.trim(), xPos, yPos);
                    line = word + ' ';
                    yPos += lineHeight;
                    xPos = padding + 95;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line.trim(), xPos, yPos);
            
            // Coordinates
            yPos += lineHeight;
            ctx.fillStyle = '#569cd6';
            ctx.fillText('coords:', padding, yPos);
            ctx.fillStyle = '#ce9178';
            ctx.fillText(`"${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}"`, padding + 95, yPos);
            
            yPos += lineHeight;
            ctx.fillStyle = '#569cd6';
            ctx.fillText('accuracy:', padding, yPos);
            ctx.fillStyle = '#ce9178';
            ctx.fillText(`"Â±${Math.round(currentLocation.accuracy)}m"`, padding + 95, yPos);

            // Convert to blob
            canvas.toBlob(async (blob) => {
                try {
                    // Try to copy to clipboard
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        statusText.innerHTML = '<span class="success">Image copied to clipboard âœ“</span>';
                    } catch (clipError) {
                        console.log('Clipboard not available:', clipError);
                        statusText.innerHTML = '<span class="success">Image captured âœ“</span>';
                    }

                    // Show preview
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(blob);
                    preview.innerHTML = '';
                    preview.appendChild(img);

                    // Open WhatsApp
                    const text = encodeURIComponent(`JOGIIA RECORD\n\n${dateStr}, ${timeStr}\n\n${currentAddress}\n\nCoordinates: ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}\nAccuracy: Â±${Math.round(currentLocation.accuracy)}m`);
                    
                    // Delay to ensure image is in clipboard
                    setTimeout(() => {
                        if (/Android/i.test(navigator.userAgent)) {
                            window.location.href = `whatsapp://send?text=${text}`;
                        } else if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                            window.location.href = `whatsapp://send?text=${text}`;
                        } else {
                            window.open(`https://web.whatsapp.com/send?text=${text}`, '_blank');
                        }
                    }, 500);

                } catch (error) {
                    statusText.innerHTML = `<span class="error">Error: ${error.message}</span>`;
                    
                    // Still show preview
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/png');
                    preview.innerHTML = '';
                    preview.appendChild(img);
                }
            }, 'image/png');
        });
    </script>
</body>
</html>
